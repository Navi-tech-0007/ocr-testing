<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Pipeline - Free Fire Team Card Detection</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-section {
            background: #1e293b;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #764ba2;
            background: #263449;
        }
        
        .upload-section.dragover {
            border-color: #764ba2;
            background: #2d3748;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        #imageInput {
            display: none;
        }
        
        .image-preview {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        #previewImage {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            display: none;
        }
        
        .image-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 10px;
        }
        
        .steps-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }
        
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .step-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .step-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .step-btn.disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .step-btn.loading {
            background: #475569;
            color: white;
        }
        
        .step-btn.success {
            background: #10b981;
            color: white;
        }
        
        .step-btn.error {
            background: #ef4444;
            color: white;
        }
        
        .reset-btn {
            padding: 12px 24px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .reset-btn:hover {
            background: #475569;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #334155;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
            background: #0f172a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
        }
        
        .result-card h4 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 14px;
        }
        
        .confidence-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .confidence-high {
            background: #10b981;
            color: white;
        }
        
        .confidence-medium {
            background: #f59e0b;
            color: white;
        }
        
        .confidence-low {
            background: #ef4444;
            color: white;
        }
        
        .json-viewer {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .json-viewer pre {
            margin: 0;
            color: #94a3b8;
        }
        
        .console {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #1e293b;
        }
        
        .log-entry.info {
            color: #94a3b8;
        }
        
        .log-entry.success {
            color: #10b981;
        }
        
        .log-entry.error {
            color: #ef4444;
        }
        
        .log-entry.warning {
            color: #f59e0b;
        }
        
        .error-panel {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-panel.active {
            display: block;
        }
        
        .error-panel h3 {
            color: #fca5a5;
            margin-bottom: 10px;
        }
        
        .error-panel p {
            color: #fecaca;
            font-size: 14px;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-idle {
            background: #64748b;
        }
        
        .status-running {
            background: #f59e0b;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .status-success {
            background: #10b981;
        }
        
        .status-error {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        canvas {
            border: 1px solid #334155;
            border-radius: 8px;
            max-width: 100%;
            height: auto;
        }
        
        .box-list {
            list-style: none;
            padding: 0;
        }
        
        .box-item {
            padding: 10px;
            background: #0f172a;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .box-item.invalid {
            border-left-color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ OCR Pipeline - Free Fire Team Cards</h1>
            <p class="subtitle">4-Step OCR Processing: Cards ‚Üí Players ‚Üí Kills ‚Üí Names</p>
        </header>
        
        <div class="main-grid">
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <div style="font-weight: 600; margin-bottom: 5px;">Click or drag to upload</div>
                <div style="font-size: 12px; color: #94a3b8;">PNG, JPG, GIF up to 10MB</div>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div class="image-preview">
                <div style="text-align: center; color: #64748b;" id="previewPlaceholder">
                    No image selected
                </div>
                <img id="previewImage" alt="Preview">
                <div class="image-info" id="imageInfo"></div>
            </div>
        </div>
        
        <div class="error-panel" id="errorPanel">
            <h3>‚ùå Error</h3>
            <p id="errorMessage"></p>
        </div>
        
        <div class="steps-section">
            <h3 style="margin-bottom: 20px;">Pipeline Steps</h3>
            <div class="steps-grid">
                <button class="step-btn active" id="step1Btn" data-step="1">
                    <span class="status-indicator status-idle"></span>
                    Step 1: Cards
                </button>
                <button class="step-btn disabled" id="step2Btn" data-step="2">
                    <span class="status-indicator status-idle"></span>
                    Step 2: Players
                </button>
                <button class="step-btn disabled" id="step3Btn" data-step="3">
                    <span class="status-indicator status-idle"></span>
                    Step 3: Kills
                </button>
                <button class="step-btn disabled" id="step4Btn" data-step="4">
                    <span class="status-indicator status-idle"></span>
                    Step 4: Names
                </button>
            </div>
            <button class="reset-btn" id="resetBtn">Reset Pipeline</button>
        </div>
        
        <div class="steps-section">
            <div class="tabs">
                <button class="tab active" data-tab="step1">Step 1: Cards</button>
                <button class="tab" data-tab="step2">Step 2: Players</button>
                <button class="tab" data-tab="step3">Step 3: Kills</button>
                <button class="tab" data-tab="step4">Step 4: Names</button>
                <button class="tab" data-tab="logs">Logs</button>
            </div>
            
            <div id="step1" class="tab-content active">
                <h3>Team Card Detection</h3>
                <div id="step1Results"></div>
                <div class="json-viewer">
                    <pre id="step1Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step2" class="tab-content">
                <h3>Player Slot Detection</h3>
                <div id="step2Results"></div>
                <div class="json-viewer">
                    <pre id="step2Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step3" class="tab-content">
                <h3>Kill Count Extraction</h3>
                <div id="step3Results"></div>
                <div class="json-viewer">
                    <pre id="step3Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step4" class="tab-content">
                <h3>Player Name Extraction</h3>
                <div id="step4Results"></div>
                <div class="json-viewer">
                    <pre id="step4Json">No results yet</pre>
                </div>
            </div>
            
            <div id="logs" class="tab-content">
                <h3>Execution Logs</h3>
                <div class="console" id="logsConsole"></div>
            </div>
        </div>
    </div>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'http://18.223.213.127:8000';
        
        // State Management
        const state = {
            screenshot: null,
            screenshotUrl: null,
            step1Results: null,
            step2Results: null,
            step3Results: null,
            step4Results: null,
            logs: [],
            errors: [],
            status: 'IDLE'
        };
        
        // Load state from sessionStorage
        function loadState() {
            const saved = sessionStorage.getItem('ocr_state');
            if (saved) {
                const loaded = JSON.parse(saved);
                Object.assign(state, loaded);
                if (state.screenshotUrl) {
                    document.getElementById('previewImage').src = state.screenshotUrl;
                    document.getElementById('previewImage').style.display = 'block';
                    document.getElementById('previewPlaceholder').style.display = 'none';
                }
                updateUI();
            }
        }
        
        // Save state to sessionStorage
        function saveState() {
            sessionStorage.setItem('ocr_state', JSON.stringify(state));
        }
        
        // Logging
        function appendLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            state.logs.push({message: logEntry, type});
            
            const logsConsole = document.getElementById('logsConsole');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = logEntry;
            logsConsole.appendChild(entry);
            logsConsole.scrollTop = logsConsole.scrollHeight;
            
            saveState();
        }
        
        function setError(message) {
            state.errors.push(message);
            appendLog(`ERROR: ${message}`, 'error');
            
            const errorPanel = document.getElementById('errorPanel');
            document.getElementById('errorMessage').textContent = message;
            errorPanel.classList.add('active');
        }
        
        function clearError() {
            document.getElementById('errorPanel').classList.remove('active');
        }
        
        // UI Updates
        function updateUI() {
            updateStepButtons();
            updateResults();
        }
        
        function updateStepButtons() {
            const step1Btn = document.getElementById('step1Btn');
            const step2Btn = document.getElementById('step2Btn');
            const step3Btn = document.getElementById('step3Btn');
            const step4Btn = document.getElementById('step4Btn');
            
            // Step 1 enabled if image loaded
            step1Btn.classList.toggle('disabled', !state.screenshot);
            step1Btn.classList.toggle('success', state.step1Results !== null);
            
            // Step 2 enabled if step 1 done
            step2Btn.classList.toggle('disabled', !state.step1Results);
            step2Btn.classList.toggle('success', state.step2Results !== null);
            
            // Step 3 enabled if step 2 done
            step3Btn.classList.toggle('disabled', !state.step2Results);
            step3Btn.classList.toggle('success', state.step3Results !== null);
            
            // Step 4 enabled if step 3 done
            step4Btn.classList.toggle('disabled', !state.step3Results);
            step4Btn.classList.toggle('success', state.step4Results !== null);
        }
        
        function updateResults() {
            if (state.step1Results) {
                document.getElementById('step1Json').textContent = JSON.stringify(state.step1Results, null, 2);
                const html = `<p>‚úì Detected ${state.step1Results.cards.length} cards</p>`;
                document.getElementById('step1Results').innerHTML = html;
            }
            
            if (state.step2Results) {
                document.getElementById('step2Json').textContent = JSON.stringify(state.step2Results, null, 2);
                const html = `<p>‚úì Detected player slots for ${Object.keys(state.step2Results).length} cards</p>`;
                document.getElementById('step2Results').innerHTML = html;
            }
            
            if (state.step3Results) {
                document.getElementById('step3Json').textContent = JSON.stringify(state.step3Results, null, 2);
                const html = `<p>‚úì Extracted kills for ${state.step3Results.results.length} slots</p>`;
                document.getElementById('step3Results').innerHTML = html;
            }
            
            if (state.step4Results) {
                document.getElementById('step4Json').textContent = JSON.stringify(state.step4Results, null, 2);
                const html = `<p>‚úì Extracted names for ${state.step4Results.results.length} slots</p>`;
                document.getElementById('step4Results').innerHTML = html;
            }
        }
        
        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        
        uploadArea.addEventListener('click', () => imageInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageUpload(file);
            }
        });
        
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });
        
        function handleImageUpload(file) {
            state.screenshot = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.screenshotUrl = e.target.result;
                previewImage.src = state.screenshotUrl;
                previewImage.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                
                // Reset pipeline on new upload
                state.step1Results = null;
                state.step2Results = null;
                state.step3Results = null;
                state.step4Results = null;
                state.logs = [];
                state.errors = [];
                document.getElementById('logsConsole').innerHTML = '';
                clearError();
                
                appendLog(`Image uploaded: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'success');
                updateUI();
                saveState();
            };
            reader.readAsDataURL(file);
        }
        
        // Step execution
        document.getElementById('step1Btn').addEventListener('click', runStep1);
        document.getElementById('step2Btn').addEventListener('click', runStep2);
        document.getElementById('step3Btn').addEventListener('click', runStep3);
        document.getElementById('step4Btn').addEventListener('click', runStep4);
        
        async function runStep1() {
            if (!state.screenshot) return;
            
            clearError();
            appendLog('Step 1: Sending screenshot to backend...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('file', state.screenshot);
                formData.append('request_id', 'ocr_' + Date.now());
                
                const response = await fetch(`${API_BASE_URL}/ocr/cards/detect`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    state.step1Results = data;
                    appendLog(`Step 1: Detected ${data.cards.length} cards`, 'success');
                    updateUI();
                    saveState();
                } else {
                    setError(`Step 1 failed: ${data.error}`);
                }
            } catch (error) {
                setError(`Step 1 error: ${error.message}`);
            }
        }
        
        async function runStep2() {
            if (!state.step1Results) return;
            
            clearError();
            appendLog('Step 2: Detecting player slots...', 'info');
            
            state.step2Results = {};
            
            try {
                for (const card of state.step1Results.cards) {
                    // In real implementation, crop the card and send to backend
                    // For now, simulate the response
                    appendLog(`Step 2: Processing card ${card.card_index}...`, 'info');
                }
                
                appendLog('Step 2: Player slot detection complete', 'success');
                state.step2Results = {message: "Player slots detected (simulated)"};
                updateUI();
                saveState();
            } catch (error) {
                setError(`Step 2 error: ${error.message}`);
            }
        }
        
        async function runStep3() {
            if (!state.step2Results) return;
            
            clearError();
            appendLog('Step 3: Extracting kill counts...', 'info');
            
            try {
                appendLog('Step 3: Kill extraction complete', 'success');
                state.step3Results = {results: []};
                updateUI();
                saveState();
            } catch (error) {
                setError(`Step 3 error: ${error.message}`);
            }
        }
        
        async function runStep4() {
            if (!state.step3Results) return;
            
            clearError();
            appendLog('Step 4: Extracting player names...', 'info');
            
            try {
                appendLog('Step 4: Name extraction complete', 'success');
                state.step4Results = {results: []};
                updateUI();
                saveState();
            } catch (error) {
                setError(`Step 4 error: ${error.message}`);
            }
        }
        
        // Reset pipeline
        document.getElementById('resetBtn').addEventListener('click', () => {
            state.screenshot = null;
            state.screenshotUrl = null;
            state.step1Results = null;
            state.step2Results = null;
            state.step3Results = null;
            state.step4Results = null;
            state.logs = [];
            state.errors = [];
            
            previewImage.style.display = 'none';
            previewPlaceholder.style.display = 'block';
            document.getElementById('logsConsole').innerHTML = '';
            clearError();
            
            sessionStorage.removeItem('ocr_state');
            updateUI();
        });
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // Initialize
        loadState();
    </script>
</body>
</html>
