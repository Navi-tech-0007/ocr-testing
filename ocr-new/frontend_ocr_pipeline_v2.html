<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Pipeline v2 - Free Fire Team Card Detection</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-section {
            background: #1e293b;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #764ba2;
            background: #263449;
        }
        
        .upload-section.dragover {
            border-color: #764ba2;
            background: #2d3748;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        #imageInput {
            display: none;
        }
        
        .image-preview {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        #previewImage {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            display: none;
        }
        
        .image-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 10px;
        }
        
        .steps-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }
        
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .step-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            position: relative;
        }
        
        .step-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .step-btn.disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .step-btn.disabled[title] {
            cursor: help;
        }
        
        .step-btn.success {
            background: #10b981;
            color: white;
        }
        
        .step-btn.error {
            background: #ef4444;
            color: white;
        }
        
        .step-btn.cached {
            background: #3b82f6;
            color: white;
        }
        
        .step-btn-label {
            display: block;
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            border: 1px solid #334155;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .modal-content p {
            margin-bottom: 20px;
            color: #cbd5e1;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #334155;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
            background: #0f172a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .json-viewer {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .json-viewer pre {
            margin: 0;
            color: #94a3b8;
        }
        
        .console {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #1e293b;
        }
        
        .log-entry.info {
            color: #94a3b8;
        }
        
        .log-entry.success {
            color: #10b981;
        }
        
        .log-entry.error {
            color: #ef4444;
        }
        
        .log-entry.warning {
            color: #f59e0b;
        }
        
        .error-panel {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-panel.active {
            display: block;
        }
        
        .error-panel h3 {
            color: #fca5a5;
            margin-bottom: 10px;
        }
        
        .error-panel p {
            color: #fecaca;
            font-size: 14px;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-cached {
            background: #3b82f6;
            color: white;
        }
        
        .status-fresh {
            background: #10b981;
            color: white;
        }
        
        .run-id {
            background: #334155;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ OCR Pipeline v2 - Free Fire Team Cards</h1>
            <p class="subtitle">5-Step OCR with Session Storage Isolation & Versioning</p>
        </header>
        
        <div class="run-id">
            Run ID: <span id="runId"></span>
        </div>
        
        <div class="main-grid">
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <div style="font-weight: 600; margin-bottom: 5px;">Click or drag to upload</div>
                <div style="font-size: 12px; color: #94a3b8;">PNG, JPG, GIF up to 10MB</div>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div class="image-preview">
                <div style="text-align: center; color: #64748b;" id="previewPlaceholder">
                    No image selected
                </div>
                <img id="previewImage" alt="Preview">
                <div class="image-info" id="imageInfo"></div>
            </div>
        </div>
        
        <div class="error-panel" id="errorPanel">
            <h3>‚ùå Error</h3>
            <p id="errorMessage"></p>
        </div>
        
        <div class="steps-section">
            <h3 style="margin-bottom: 20px;">Pipeline Steps</h3>
            <div class="steps-grid">
                <button class="step-btn active" id="step1Btn" data-step="1">
                    Step 1<br><span class="step-btn-label">Cards</span>
                </button>
                <button class="step-btn disabled" id="step2Btn" data-step="2">
                    Step 2<br><span class="step-btn-label">Players</span>
                </button>
                <button class="step-btn disabled" id="step3Btn" data-step="3">
                    Step 3<br><span class="step-btn-label">Kills</span>
                </button>
                <button class="step-btn disabled" id="step4Btn" data-step="4">
                    Step 4<br><span class="step-btn-label">Names</span>
                </button>
                <button class="step-btn disabled" id="step5Btn" data-step="5">
                    Step 5<br><span class="step-btn-label">Finalize</span>
                </button>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" id="resetBtn">Reset Session Storage</button>
                <button class="btn btn-secondary" id="clearImageBtn">Clear Image</button>
            </div>
        </div>
        
        <div class="steps-section">
            <div class="tabs">
                <button class="tab active" data-tab="step1">Step 1</button>
                <button class="tab" data-tab="step2">Step 2</button>
                <button class="tab" data-tab="step3">Step 3</button>
                <button class="tab" data-tab="step4">Step 4</button>
                <button class="tab" data-tab="step5">Step 5</button>
                <button class="tab" data-tab="logs">Logs</button>
            </div>
            
            <div id="step1" class="tab-content active">
                <h3>Team Card Detection</h3>
                <div id="step1Results"></div>
                <div class="json-viewer">
                    <pre id="step1Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step2" class="tab-content">
                <h3>Player Slot Detection</h3>
                <div id="step2Results"></div>
                <div class="json-viewer">
                    <pre id="step2Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step3" class="tab-content">
                <h3>Kill Count Extraction</h3>
                <div id="step3Results"></div>
                <div class="json-viewer">
                    <pre id="step3Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step4" class="tab-content">
                <h3>Player Name Extraction</h3>
                <div id="step4Results"></div>
                <div class="json-viewer">
                    <pre id="step4Json">No results yet</pre>
                </div>
            </div>
            
            <div id="step5" class="tab-content">
                <h3>Final Assembly & Validation</h3>
                <div id="step5Results"></div>
                <div class="json-viewer">
                    <pre id="step5Json">No results yet</pre>
                </div>
            </div>
            
            <div id="logs" class="tab-content">
                <h3>Execution Logs</h3>
                <div class="console" id="logsConsole"></div>
            </div>
        </div>
    </div>
    
    <!-- Reuse Modal -->
    <div class="modal" id="reuseModal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Existing Result Found</h3>
            <p id="reuseModalMessage"></p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="reuseCancel">Cancel</button>
                <button class="btn btn-secondary" id="reuseFresh">Run Fresh Again</button>
                <button class="btn btn-primary" id="reuseExisting">Reuse Existing</button>
            </div>
        </div>
    </div>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'http://18.223.213.127:8000';
        
        // Generate unique run ID
        const runId = 'run_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('runId').textContent = runId;
        
        // State Management
        const state = {
            runId: runId,
            screenshot: null,
            screenshotUrl: null,
            step1Results: null,
            step2Results: null,
            step3Results: null,
            step4Results: null,
            step5Results: null,
            logs: [],
            errors: []
        };
        
        // Storage Keys (Versioned & Isolated)
        const STORAGE_KEYS = {
            step1: `ocr_step1_v1_${runId}`,
            step2: `ocr_step2_v1_${runId}`,
            step3: `ocr_step3_v1_${runId}`,
            step4: `ocr_step4_v1_${runId}`,
            step5: `ocr_step5_v1_${runId}`,
            logs: `ocr_logs_${runId}`,
            errors: `ocr_errors_${runId}`,
            screenshot: `ocr_screenshot_${runId}`
        };
        
        // Load state from sessionStorage
        function loadState() {
            const keys = Object.keys(STORAGE_KEYS);
            for (const key of keys) {
                const storageKey = STORAGE_KEYS[key];
                const saved = sessionStorage.getItem(storageKey);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        if (key === 'screenshot') {
                            state.screenshotUrl = data;
                        } else if (key === 'logs') {
                            state.logs = data;
                        } else if (key === 'errors') {
                            state.errors = data;
                        } else {
                            state[`${key}Results`] = data.data;
                        }
                    } catch (e) {
                        console.error(`Failed to load ${key}:`, e);
                    }
                }
            }
            
            if (state.screenshotUrl) {
                document.getElementById('previewImage').src = state.screenshotUrl;
                document.getElementById('previewImage').style.display = 'block';
                document.getElementById('previewPlaceholder').style.display = 'none';
            }
            
            updateUI();
            restoreLogs();
        }
        
        // Save state to sessionStorage
        function saveStepResult(stepNum, data) {
            const key = STORAGE_KEYS[`step${stepNum}`];
            const wrapped = {
                run_id: runId,
                step: stepNum,
                timestamp: Date.now(),
                model: 'claude-3-7-sonnet-vision',
                data: data
            };
            sessionStorage.setItem(key, JSON.stringify(wrapped));
            state[`step${stepNum}Results`] = data;
        }
        
        // Logging
        function appendLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            state.logs.push({message: logEntry, type});
            
            const logsConsole = document.getElementById('logsConsole');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = logEntry;
            logsConsole.appendChild(entry);
            logsConsole.scrollTop = logsConsole.scrollHeight;
            
            sessionStorage.setItem(STORAGE_KEYS.logs, JSON.stringify(state.logs));
        }
        
        function restoreLogs() {
            const logsConsole = document.getElementById('logsConsole');
            logsConsole.innerHTML = '';
            for (const log of state.logs) {
                const entry = document.createElement('div');
                entry.className = `log-entry ${log.type}`;
                entry.textContent = log.message;
                logsConsole.appendChild(entry);
            }
        }
        
        function setError(message) {
            state.errors.push(message);
            appendLog(`ERROR: ${message}`, 'error');
            
            const errorPanel = document.getElementById('errorPanel');
            document.getElementById('errorMessage').textContent = message;
            errorPanel.classList.add('active');
        }
        
        function clearError() {
            document.getElementById('errorPanel').classList.remove('active');
        }
        
        // UI Updates
        function updateUI() {
            updateStepButtons();
            updateResults();
        }
        
        function updateStepButtons() {
            const buttons = [
                {btn: document.getElementById('step1Btn'), has: state.screenshot},
                {btn: document.getElementById('step2Btn'), has: state.step1Results},
                {btn: document.getElementById('step3Btn'), has: state.step2Results},
                {btn: document.getElementById('step4Btn'), has: state.step3Results},
                {btn: document.getElementById('step5Btn'), has: state.step4Results}
            ];
            
            buttons.forEach((item, idx) => {
                const stepNum = idx + 1;
                const hasCached = sessionStorage.getItem(STORAGE_KEYS[`step${stepNum}`]) !== null;
                const hasData = item.has;
                
                item.btn.classList.remove('disabled', 'success', 'cached');
                
                if (!item.has && !hasCached) {
                    item.btn.classList.add('disabled');
                    item.btn.title = `Step ${stepNum - 1} must be completed first`;
                } else if (hasData) {
                    item.btn.classList.add('success');
                    item.btn.title = '';
                } else if (hasCached) {
                    item.btn.classList.add('cached');
                    item.btn.title = `Cached result available`;
                }
            });
        }
        
        function updateResults() {
            if (state.step1Results) {
                document.getElementById('step1Json').textContent = JSON.stringify(state.step1Results, null, 2);
            }
            if (state.step2Results) {
                document.getElementById('step2Json').textContent = JSON.stringify(state.step2Results, null, 2);
            }
            if (state.step3Results) {
                document.getElementById('step3Json').textContent = JSON.stringify(state.step3Results, null, 2);
            }
            if (state.step4Results) {
                document.getElementById('step4Json').textContent = JSON.stringify(state.step4Results, null, 2);
            }
            if (state.step5Results) {
                document.getElementById('step5Json').textContent = JSON.stringify(state.step5Results, null, 2);
            }
        }
        
        // Check for cached result before running step
        async function checkCachedResult(stepNum) {
            const key = STORAGE_KEYS[`step${stepNum}`];
            const cached = sessionStorage.getItem(key);
            
            if (!cached) {
                return null; // No cached result
            }
            
            try {
                const data = JSON.parse(cached);
                return data;
            } catch (e) {
                return null;
            }
        }
        
        // Show reuse modal
        function showReuseModal(stepNum, cachedData) {
            return new Promise((resolve) => {
                const modal = document.getElementById('reuseModal');
                const message = document.getElementById('reuseModalMessage');
                
                message.textContent = `We found an existing result for Step ${stepNum} (${new Date(cachedData.timestamp).toLocaleString()}). Would you like to reuse it or generate a fresh result?`;
                
                const handleReuse = () => {
                    modal.classList.remove('active');
                    resolve('reuse');
                    cleanup();
                };
                
                const handleFresh = () => {
                    modal.classList.remove('active');
                    invalidatePipelineFrom(stepNum);
                    resolve('fresh');
                    cleanup();
                };
                
                const handleCancel = () => {
                    modal.classList.remove('active');
                    resolve('cancel');
                    cleanup();
                };
                
                const cleanup = () => {
                    document.getElementById('reuseExisting').removeEventListener('click', handleReuse);
                    document.getElementById('reuseFresh').removeEventListener('click', handleFresh);
                    document.getElementById('reuseCancel').removeEventListener('click', handleCancel);
                };
                
                document.getElementById('reuseExisting').addEventListener('click', handleReuse);
                document.getElementById('reuseFresh').addEventListener('click', handleFresh);
                document.getElementById('reuseCancel').addEventListener('click', handleCancel);
                
                modal.classList.add('active');
            });
        }
        
        // Invalidate pipeline from step onwards
        function invalidatePipelineFrom(stepNum) {
            for (let i = stepNum; i <= 5; i++) {
                const key = STORAGE_KEYS[`step${i}`];
                sessionStorage.removeItem(key);
                state[`step${i}Results`] = null;
            }
            appendLog(`Pipeline invalidated from Step ${stepNum} onwards`, 'warning');
            updateUI();
        }
        
        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        
        uploadArea.addEventListener('click', () => imageInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageUpload(file);
            }
        });
        
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });
        
        function handleImageUpload(file) {
            state.screenshot = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.screenshotUrl = e.target.result;
                previewImage.src = state.screenshotUrl;
                previewImage.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                
                // Invalidate all steps on new upload
                invalidatePipelineFrom(1);
                
                sessionStorage.setItem(STORAGE_KEYS.screenshot, state.screenshotUrl);
                appendLog(`Image uploaded: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'success');
                updateUI();
            };
            reader.readAsDataURL(file);
        }
        
        // Step execution
        document.getElementById('step1Btn').addEventListener('click', runStep1);
        document.getElementById('step2Btn').addEventListener('click', runStep2);
        document.getElementById('step3Btn').addEventListener('click', runStep3);
        document.getElementById('step4Btn').addEventListener('click', runStep4);
        document.getElementById('step5Btn').addEventListener('click', runStep5);
        
        async function runStep1() {
            if (!state.screenshot) return;
            
            clearError();
            
            // Check for cached result
            const cached = await checkCachedResult(1);
            if (cached) {
                const choice = await showReuseModal(1, cached);
                if (choice === 'reuse') {
                    state.step1Results = cached.data;
                    appendLog('Step 1: Using cached result', 'success');
                    updateUI();
                    return;
                } else if (choice === 'cancel') {
                    return;
                }
            }
            
            appendLog('Step 1: Sending screenshot to backend...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('file', state.screenshot);
                formData.append('request_id', runId);
                
                const response = await fetch(`${API_BASE_URL}/ocr/cards/detect`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    saveStepResult(1, data);
                    appendLog(`Step 1: Detected ${data.cards.length} cards`, 'success');
                    updateUI();
                } else {
                    setError(`Step 1 failed: ${data.error}`);
                }
            } catch (error) {
                setError(`Step 1 error: ${error.message}`);
            }
        }
        
        async function runStep2() {
            if (!state.step1Results) return;
            
            clearError();
            
            const cached = await checkCachedResult(2);
            if (cached) {
                const choice = await showReuseModal(2, cached);
                if (choice === 'reuse') {
                    state.step2Results = cached.data;
                    appendLog('Step 2: Using cached result', 'success');
                    updateUI();
                    return;
                } else if (choice === 'cancel') {
                    return;
                }
            }
            
            appendLog('Step 2: Detecting player slots...', 'info');
            
            try {
                const mockResult = {message: "Player slots detected (simulated)"};
                saveStepResult(2, mockResult);
                appendLog('Step 2: Player slot detection complete', 'success');
                updateUI();
            } catch (error) {
                setError(`Step 2 error: ${error.message}`);
            }
        }
        
        async function runStep3() {
            if (!state.step2Results) return;
            
            clearError();
            
            const cached = await checkCachedResult(3);
            if (cached) {
                const choice = await showReuseModal(3, cached);
                if (choice === 'reuse') {
                    state.step3Results = cached.data;
                    appendLog('Step 3: Using cached result', 'success');
                    updateUI();
                    return;
                } else if (choice === 'cancel') {
                    return;
                }
            }
            
            appendLog('Step 3: Extracting kill counts...', 'info');
            
            try {
                const mockResult = {results: []};
                saveStepResult(3, mockResult);
                appendLog('Step 3: Kill extraction complete', 'success');
                updateUI();
            } catch (error) {
                setError(`Step 3 error: ${error.message}`);
            }
        }
        
        async function runStep4() {
            if (!state.step3Results) return;
            
            clearError();
            
            const cached = await checkCachedResult(4);
            if (cached) {
                const choice = await showReuseModal(4, cached);
                if (choice === 'reuse') {
                    state.step4Results = cached.data;
                    appendLog('Step 4: Using cached result', 'success');
                    updateUI();
                    return;
                } else if (choice === 'cancel') {
                    return;
                }
            }
            
            appendLog('Step 4: Extracting player names...', 'info');
            
            try {
                const mockResult = {results: []};
                saveStepResult(4, mockResult);
                appendLog('Step 4: Name extraction complete', 'success');
                updateUI();
            } catch (error) {
                setError(`Step 4 error: ${error.message}`);
            }
        }
        
        async function runStep5() {
            if (!state.step4Results) return;
            
            clearError();
            
            const cached = await checkCachedResult(5);
            if (cached) {
                const choice = await showReuseModal(5, cached);
                if (choice === 'reuse') {
                    state.step5Results = cached.data;
                    appendLog('Step 5: Using cached result', 'success');
                    updateUI();
                    return;
                } else if (choice === 'cancel') {
                    return;
                }
            }
            
            appendLog('Step 5: Assembling final result...', 'info');
            
            try {
                const mockResult = {teams: []};
                saveStepResult(5, mockResult);
                appendLog('Step 5: Final assembly complete', 'success');
                updateUI();
            } catch (error) {
                setError(`Step 5 error: ${error.message}`);
            }
        }
        
        // Reset session storage
        document.getElementById('resetBtn').addEventListener('click', () => {
            const keys = Object.keys(STORAGE_KEYS);
            for (const key of keys) {
                sessionStorage.removeItem(STORAGE_KEYS[key]);
            }
            
            state.step1Results = null;
            state.step2Results = null;
            state.step3Results = null;
            state.step4Results = null;
            state.step5Results = null;
            state.logs = [];
            state.errors = [];
            
            document.getElementById('logsConsole').innerHTML = '';
            clearError();
            
            appendLog('Session storage cleared', 'warning');
            updateUI();
        });
        
        // Clear image
        document.getElementById('clearImageBtn').addEventListener('click', () => {
            state.screenshot = null;
            state.screenshotUrl = null;
            previewImage.style.display = 'none';
            previewPlaceholder.style.display = 'block';
            imageInput.value = '';
            
            invalidatePipelineFrom(1);
            sessionStorage.removeItem(STORAGE_KEYS.screenshot);
            
            appendLog('Image cleared', 'info');
        });
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // Initialize
        loadState();
    </script>
</body>
</html>
